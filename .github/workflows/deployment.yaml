name: Find My Buckets in Main Account

on:
  workflow_dispatch:

jobs:
  find-buckets:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Get Account Info
      run: |
        echo "ğŸ” You are in COMPANY MAIN ACCOUNT"
        echo "ğŸ‘¤ IAM User: jqchoo@strateqgroup.com"
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        echo "ğŸ¢ Account ID: $ACCOUNT_ID"

    - name: Create AND FIND Bucket
      run: |
        echo "ğŸš€ Creating bucket in main account..."
        BUCKET_NAME="main-account-test-$(date +%s)"
        echo "ğŸ“¦ Bucket: $BUCKET_NAME"
        
        # Create bucket
        aws s3api create-bucket \
          --bucket "$BUCKET_NAME" \
          --region us-east-1
        
        echo "âœ… Bucket created!"
        
        # Wait a moment
        sleep 5
        
        # Verify it exists
        echo "ğŸ” Verifying bucket exists via API..."
        if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
          echo "ğŸ‰ API CONFIRMS: Bucket '$BUCKET_NAME' EXISTS in main account!"
        else
          echo "âŒ API says bucket doesn't exist - possible permission issue"
        fi

    - name: List Recent Buckets
      run: |
        echo "ğŸ“Š Listing ALL buckets in main account (recent first):"
        aws s3api list-buckets --query 'sort_by(Buckets, &CreationDate)[-10:].{Name: Name, Created: CreationDate}' --output table

    - name: Check S3 Permissions
      run: |
        echo "ğŸ” Checking your S3 permissions..."
        echo "Testing LIST permission:"
        aws s3 ls && echo "âœ… Can list buckets" || echo "âŒ Cannot list buckets"
        
        echo "Testing CREATE permission:"
        # We already tested this above

    - name: Important Instructions for Main Account
      run: |
        echo ""
        echo "ğŸ¯ YOU ARE IN YOUR COMPANY'S MAIN AWS ACCOUNT"
        echo "=============================================="
        echo "ğŸ‘¤ IAM User: jqchoo@strateqgroup.com"
        echo ""
        echo "ğŸ” IN AWS CONSOLE, CHECK:"
        echo "1. Make sure you're logged in as jqchoo@strateqgroup.com"
        echo "2. Go to S3 service"
        echo "3. Look for buckets starting with 'main-account-test-'"
        echo "4. Also check if there are MANY buckets (might be hard to find)"
        echo ""
        echo "âš ï¸  If you still can't find buckets:"
        echo "â€¢ Ask your mentor about S3 permissions"
        echo "â€¢ You might need 's3:ListAllMyBuckets' permission"
        echo "â€¢ Or buckets might be in a different organization unit"
